<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders</title>
</head>
<body>

    <%- include('partials/header') %>

    <h2>Current Orders</h2>

    <% const today = new Date(); today.setHours(0, 0, 0, 0); %>

    <% orders.forEach(order => { 
        const orderDate = new Date(order.date);
        orderDate.setHours(0, 0, 0, 0);
        const isToday = orderDate.getTime() === today.getTime();
        const isFuture = orderDate.getTime() > today.getTime();
    %>
        <section class="order-card">
            <p><strong>Date:</strong> <%= order.date.toDateString() %></p>
            <p><strong>Total:</strong> £<%= order.total %></p>
            <p><strong>Fast-Track Rides:</strong> <%= order.fastRides.join(", ") || "None" %></p>
            
            <% if (!order.confirmed) { %>
                <form action="/orders/add-ride" method="POST">
                    <input type="hidden" name="orderId" value="<%= order._id %>">
                    <label for="ride">Add Fast-Tracks:</label>
                    <select name="ride">
                        <% rides.forEach(ride => { %>
                            <option value="<%= ride.name %>"><%= ride.name %> (£<%= ride.cost %>)</option>
                        <% }) %>
                    </select>
                    <button type="submit">Add</button>
                </form>

                <form action="/orders/confirm/<%= order._id %>" method="GET">
                    <button type="submit">Buy Ticket</button>
                </form>

            <% } else if (isFuture) { %>
                <p>Status: Confirmed</p>

                <form action="/orders/add-ride" method="POST">
                    <input type="hidden" name="orderId" value="<%= order._id %>">
                    <label for="ride">Add Fast-Tracks:</label>
                    <select name="ride">
                        <% rides.forEach(ride => { %>
                            <option value="<%= ride.name %>"><%= ride.name %> (£<%= ride.cost %>)</option>
                        <% }) %>
                    </select>
                    <button type="submit">Add</button>
                </form>

            <% } else if (isToday) { %>
                <p>Status: Confirmed - Valid for Today</p>

                <form action="/orders/use" method="POST">
                    <input type="hidden" name="orderId" value="<%= order._id %>">
                    <button type="submit">Use Ticket</button>
                </form>

            <% } %>
        </section>
    <% }) %>

    <a href="/orders/history">View previous orders</a>

    <%- include('partials/footer') %>

</body>
</html>
